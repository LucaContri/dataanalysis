<!DOCTYPE html>
<html>
  <head>
  	<title>Active Resources Test</title>
    <style>
      #map_canvas {
        width: 900px;
        height: 500px;
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?libraries=geometry,visualization&sensor=true"></script>
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <script>
      google.load('visualization', '1', {'packages':['table']});
      var currentZoomLevel = 4;
      function initialize() {
	  	 var map;
	  	 var gMarkers=[];
	  	 var map_canvas = document.getElementById('map_canvas');
		 var map_options = {
	        center: new google.maps.LatLng(-33, 150),
	        zoom: currentZoomLevel,
	        mapTypeId: google.maps.MapTypeId.TERRAIN
	     };
	
	     map = new google.maps.Map(map_canvas, map_options);
         
	     var query = new google.visualization.Query('resources');
	
         query.send(function(response) {
       	  	 var data = response.getDataTable();
             var numRows = response.getDataTable().getNumberOfRows();
             var heatmapData = [];
             for(var i = 0; i < numRows; i++) {
           	  	var latLng = new google.maps.LatLng(data.getValue(i,0),data.getValue(i,1));
           	 	heatmapData.push(latLng);
           	 	gMarkers.push(new google.maps.Marker({
       	        	position: latLng,
       	      		map: map,
       	      		title: data.getValue(i,2) + "\nFTEs: " + data.getValue(i,3) + "\nContractors: " + data.getValue(i,4),
       	      		icon: getCircle(data.getValue(i,3))
       	      	}));
             }
             //var heatmap = new google.maps.visualization.HeatmapLayer({
	         //      data: heatmapData,
	         //      dissipating: false,
	         //      map: map
	         //    });
             var table = new google.visualization.Table(document.getElementById('table_div'));
             table.draw(data, {width: 1200, height: 700, is3D: true, });
             
         });
         
         google.maps.event.addListener(map, 'zoom_changed', function() {
        	 currentZoomLevel = map.getZoom();
             
             for(var i=0; i< gMarkers.length; i++ ) {
                 gMarkers[i].setIcon(updateCircle(gMarkers[i].getIcon()));
             }
             
         });
      }
      function getCircle(magnitude) {
    	  return {
    		    path: google.maps.SymbolPath.CIRCLE,
    		    fillColor: 'red',
    		    fillOpacity: .1,
    		    scaleOrig: magnitude,
    		    scale: magnitude*getScale(),
    		    strokeColor: 'white',
    		    strokeWeight: .5
    		  };
      }
      function updateCircle(originalIcon) {
    	  originalIcon.scale = originalIcon.scaleOrig*getScale();
    	  return originalIcon;
      }
      function getScale() {
    	  return Math.max(Math.pow(currentZoomLevel,1.3) -4, 0.5);
      }
      google.maps.event.addDomListener(window, 'load', initialize);
    </script>
  </head>
  <body>
  	<h2>Active Resources by Standard</h2>
  	<h3>Map</h3>
    <div id="map_canvas"></div>
    <h3>Data</h3>
    <div id="table_div"></div>
  </body>
</html>